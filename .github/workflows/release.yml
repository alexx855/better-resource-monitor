name: Release

# Required secrets:
# - APPLE_CERTIFICATE: Base64-encoded .p12 certificate
# - APPLE_CERTIFICATE_PASSWORD: Certificate password
# - APPLE_ID: Apple Developer account email
# - APPLE_PASSWORD: App-specific password for notarization
# - APPLE_TEAM_ID: Team ID for notarization

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  version-bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      release_notes: ${{ steps.notes.outputs.release_notes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version and bump
        id: bump
        run: |
          CURRENT=$(jq -r '.version' package.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping from $CURRENT to $NEW_VERSION"

      - name: Update version in all files
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          # Update package.json
          jq ".version = \"$NEW_VERSION\"" package.json > tmp.json && mv tmp.json package.json

          # Update tauri.conf.json
          jq ".version = \"$NEW_VERSION\"" src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" src-tauri/Cargo.toml

      - name: Generate release notes
        id: notes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi

          # Escape for GitHub Actions output
          NOTES=$(echo "$COMMITS" | sed 's/"/\\"/g')

          # Write to file for multiline output
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          if [ -z "$COMMITS" ]; then
            echo "- Version bump to ${{ steps.bump.outputs.new_version }}" >> release_notes.md
          else
            echo "$COMMITS" >> release_notes.md
          fi
          echo "" >> release_notes.md
          if [ -n "$LAST_TAG" ]; then
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${{ steps.bump.outputs.new_version }}" >> release_notes.md
          fi

          # Output using delimiter for multiline
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README download links
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          # Update macOS download link (productName "Better Resource Monitor" -> Better.Resource.Monitor)
          sed -i 's|releases/download/v[0-9.]*|releases/download/v'"$NEW_VERSION"'|g' README.md
          sed -i 's|Better\.Resource\.Monitor_[0-9.]*_aarch64\.dmg|Better.Resource.Monitor_'"$NEW_VERSION"'_aarch64.dmg|g' README.md

          # Update Ubuntu download link (productName -> lowercase with hyphens)
          sed -i 's|better-resource-monitor_[0-9.]*_amd64\.deb|better-resource-monitor_'"$NEW_VERSION"'_amd64.deb|g' README.md

      - name: Commit and tag
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          git add -A
          git commit -m "chore: bump version to $NEW_VERSION"
          git tag "v$NEW_VERSION"
          git push origin main
          git push origin "v$NEW_VERSION"

  publish-tauri:
    needs: version-bump
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''

    runs-on: ${{ matrix.platform }}
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.new_version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build and create release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: v${{ needs.version-bump.outputs.new_version }}
          releaseName: 'Better Resource Monitor v${{ needs.version-bump.outputs.new_version }}'
          releaseBody: ${{ needs.version-bump.outputs.release_notes }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
